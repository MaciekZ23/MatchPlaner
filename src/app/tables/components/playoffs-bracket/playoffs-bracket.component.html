<div class="card bg-dark text-white">
  <h2
    id="playoffsTitle"
    class="card-title card-header bg-transparent d-flex justify-content-between align-items-center fs-5 text p-3"
  >
    <span>{{ moduleStrings.title }}</span>
    <button
      class="btn btn-link text-white p-0 btn-sm"
      type="button"
      (click)="toggleCollapse()"
      [attr.aria-label]="isCollapsed ? 'Rozwiń sekcję' : 'Zwiń sekcję'"
      [attr.aria-expanded]="!isCollapsed"
      aria-controls="playoffsCollapse"
    >
      <i
        class="fas"
        [ngClass]="{
          'fa-chevron-down': isCollapsed,
          'fa-chevron-up': !isCollapsed
        }"
        aria-hidden="true"
      ></i>
    </button>
  </h2>
  <div
    class="collapse"
    [ngClass]="{ show: !isCollapsed }"
    id="playoffsCollapse"
  >
    <div
      class="card-body"
      tabindex="0"
      role="region"
      aria-labelledby="playoffsTitle"
    >
      <ng-container *ngIf="matches$ | async as matches">
        <ng-container *ngIf="roundSides$ | async as sides; else emptyTpl">
          <ng-container *ngIf="uiMatchById$ | async as ui">
            <div
              class="bracket-grid"
              [style.--card-h.px]="matchCardHeight"
              [style.--v-gap.px]="vGap"
            >
              <div class="side left">
                <ng-container *ngFor="let r of sides.left; trackBy: trackRound">
                  <ng-container *ngIf="r > 1">
                    <div
                      class="round"
                      [attr.data-round]="r"
                      [style.--offset-mult]="
                        (roundOffsetMult$ | async)?.get(r) ?? 0
                      "
                    >
                      <div class="round-col">
                        <ng-container *ngIf="matches | bracketRound : r as arr">
                          <div
                            class="match-wrap"
                            *ngFor="
                              let m of leftHalf(matches, r);
                              trackBy: trackMatch
                            "
                          >
                            <div class="text-white text-center">
                              {{ bracket.matchTitle(m.round, m.index) }}
                            </div>
                            <app-match-card
                              #cardProbe
                              class="match-card-compact"
                              [match]="ui.get(m.id)!"
                              (openDetails)="openDetails($event)"
                            ></app-match-card>
                          </div>
                        </ng-container>
                      </div>
                    </div>
                  </ng-container>
                </ng-container>
              </div>

              <div class="center-col">
                <ng-container *ngIf="matches | bracketRound : 1 as finalsArr">
                  <div class="center-final" *ngIf="finalsArr.length > 0">
                    <div class="round-title text-center">
                      {{ bracket.matchTitle(1, 1) }}
                    </div>
                    <app-match-card
                      class="match-card-compact"
                      [match]="ui.get(finalsArr[0].id)!"
                      (openDetails)="openDetails($event)"
                    ></app-match-card>
                  </div>

                  <div class="center-third" *ngIf="finalsArr.length > 1">
                    <div class="round-title text-center">
                      {{ bracket.matchTitle(1, 2) }}
                    </div>
                    <app-match-card
                      class="match-card-compact"
                      [match]="ui.get(finalsArr[1].id)!"
                      (openDetails)="openDetails($event)"
                    ></app-match-card>
                  </div>
                </ng-container>
              </div>

              <div class="side right">
                <ng-container
                  *ngFor="let r of sides.right; trackBy: trackRound"
                >
                  <ng-container *ngIf="r > 1">
                    <div
                      class="round"
                      [attr.data-round]="r"
                      [style.--offset-mult]="
                        (roundOffsetMult$ | async)?.get(r) ?? 0
                      "
                    >
                      <div class="round-col">
                        <ng-container *ngIf="matches | bracketRound : r as arr">
                          <div
                            class="match-wrap"
                            *ngFor="
                              let m of rightHalf(matches, r);
                              trackBy: trackMatch
                            "
                          >
                            <div class="text-white text-center">
                              {{ bracket.matchTitle(m.round, m.index) }}
                            </div>
                            <app-match-card
                              #cardProbe
                              class="match-card-compact"
                              [match]="ui.get(m.id)!"
                              (openDetails)="openDetails($event)"
                            ></app-match-card>
                          </div>
                        </ng-container>
                      </div>
                    </div>
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>
      <ng-template #emptyTpl>
        <div class="alert alert-secondary m-0">
          Brak danych drabinki do wyświetlenia.
        </div>
      </ng-template>
    </div>
  </div>
</div>
