<div
  class="modal fade"
  id="{{ idModal }}"
  tabindex="-1"
  [attr.aria-labelledby]="this.idModal"
  data-bs-keyboard="false"
  data-bs-backdrop="static"
>
  <div
    class="modal-dialog modal-dialog-centered modal-lg"
    [ngClass]="{ 'modal-dialog-centered': windowWidth >= 768 }"
  >
    <div class="modal-content bg-dark text-light rounded-3">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="formModalLabel">{{ formTitle }}</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
          (click)="this.close.emit()"
        ></button>
      </div>
      <div class="modal-body justify-content-center d-flex">
        <form
          [formGroup]="form"
          (ngSubmit)="onSubmit()"
          class="container d-flex row justify-content-center column-gap-4 h-100"
        >
          @for (field of fields; track trackField($index, field)) {

          <div class="mb-3 px-0 row" [class]="calcTotalSpan(field)">
            <div [class]="calcActualSpan(field)">
              @if(field.type !== 'repeater' && field.displayLabel !== false) {
              <label [for]="field.name" class="form-label">{{
                field.label
              }}</label>
              } @switch (field.type) { @case('text'){
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="text"
                class="form-control"
                [placeholder]="field.placeholder || ''"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              />
              }@case('hidden') {
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="hidden"
              />
              } @case('email'){
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="email"
                class="form-control"
                [placeholder]="field.placeholder || ''"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              />
              } @case('number'){
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="number"
                class="form-control"
                [min]="field.min !== undefined ? field.min : NumMin"
                [max]="field.max ? field.max : NumMax"
                [step]="field.step !== undefined ? field.step : 1"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              />
              } @case('date'){
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="date"
                class="form-control"
                [min]="field.min"
                [max]="field.max"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              />
              } @case('time'){
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="time"
                class="form-control"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              />
              } @case('datetime'){
              <input
                [id]="field.name"
                [formControlName]="field.name"
                type="datetime-local"
                class="form-control"
                [step]="600"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              />
              } @case('checkbox'){
              <div class="form-check">
                <input
                  [id]="field.name"
                  [formControlName]="field.name"
                  type="checkbox"
                  class="form-check-input"
                />
                <label [for]="field.name" class="form-check-label">{{
                  field.label
                }}</label>
              </div>
              } @case('textarea'){
              <textarea
                [id]="field.name"
                [formControlName]="field.name"
                class="form-control"
                [rows]="field.rows || 4"
                [placeholder]="field.placeholder || ''"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              ></textarea>
              } @case('select'){
              <select
                [id]="field.name"
                [formControlName]="field.name"
                class="form-select"
                [multiple]="field?.multiple || false"
                [ngClass]="{
                  'is-invalid':
                    form.get(field.name)?.invalid &&
                    form.get(field.name)?.touched
                }"
              >
                <option
                  *ngFor="let option of field.options"
                  [value]="option.value"
                >
                  {{ option.label }}
                </option>
              </select>

              }@case('repeater') {
              <div [formArrayName]="field.name" class="repeater">
                <div class="d-flex justify-content-end align-items-center mb-2">
                  <h6 class="mb-0 me-auto">{{ field.label }}</h6>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-light d-inline-flex align-items-center"
                    (click)="addRepeaterItem(field.name)"
                  >
                    <i class="fa-solid fa-plus"></i>
                    <span class="ms-2">{{ asRepeater(field).addLabel }}</span>
                  </button>
                </div>

                <div class="vstack gap-3">
                  <div
                    class="border border-2 rounded-4 p-3"
                    *ngFor="
                      let g of getFormArray(field.name).controls;
                      let i = index
                    "
                    [formGroupName]="i"
                  >
                    <div class="mb-2 fw-semibold">
                      {{ asRepeater(field).itemLabel }} {{ i + 1 }}
                    </div>

                    <div class="row g-3">
                      @for (inner of asRepeater(field).fields; track $index) {
                      <div class="col-12">
                        @if(inner.displayLabel !== false && inner.type !==
                        'hidden') {
                        <label class="form-label">
                          {{ inner.label }}
                        </label>
                        } @switch (inner.type) { @case('text') {
                        <input
                          type="text"
                          class="form-control"
                          [formControlName]="inner.name"
                          [placeholder]="inner.placeholder || ''"
                        />
                        } @case('hidden') {
                        <input type="hidden" [formControlName]="inner.name" />
                        } @case('email') {
                        <input
                          type="email"
                          class="form-control"
                          [formControlName]="inner.name"
                          [placeholder]="inner.placeholder || ''"
                        />
                        } @case('number') {
                        <input
                          type="number"
                          class="form-control"
                          [formControlName]="inner.name"
                          [min]="inner.min ?? null"
                          [max]="inner.max ?? null"
                          [step]="inner.step ?? 1"
                        />

                        } @case('date') {
                        <input
                          type="date"
                          class="form-control"
                          [formControlName]="inner.name"
                          [min]="inner.min"
                          [max]="inner.max"
                        />
                        } @case('time') {
                        <input
                          type="time"
                          class="form-control"
                          [formControlName]="inner.name"
                        />
                        } @case('datetime') {
                        <input
                          type="datetime-local"
                          class="form-control"
                          [formControlName]="inner.name"
                          [step]="600"
                        />
                        } @case('checkbox') {
                        <div class="form-check">
                          <input
                            type="checkbox"
                            class="form-check-input"
                            [formControlName]="inner.name"
                          />
                          <label class="form-check-label">{{
                            inner.label
                          }}</label>
                        </div>
                        } @case('textarea') {
                        <textarea
                          class="form-control"
                          [rows]="inner.rows || 3"
                          [placeholder]="inner.placeholder || ''"
                          [formControlName]="inner.name"
                        ></textarea>
                        } @case('select') {
                        <select
                          class="form-select"
                          [formControlName]="inner.name"
                          [multiple]="inner?.multiple || false"
                        >
                          <ng-container
                            *ngIf="asRepeater(field).optionsByIndex?.[i]?.[inner.name] as perRowOpts; else defaultOpts"
                          >
                            <option
                              *ngFor="let option of perRowOpts"
                              [value]="option.value"
                            >
                              {{ option.label }}
                            </option>
                          </ng-container>
                          <ng-template #defaultOpts>
                            <option
                              *ngFor="let option of inner.options"
                              [value]="option.value"
                            >
                              {{ option.label }}
                            </option>
                          </ng-template>
                        </select>

                        } }
                      </div>
                      }
                    </div>

                    <div
                      class="d-flex justify-content-end align-items-center mt-2"
                    >
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-danger d-inline-flex align-items-center"
                        (click)="removeRepeaterItem(field.name, i)"
                      >
                        <i class="fa-solid fa-trash-can"></i>
                        <span class="ms-2">{{
                          asRepeater(field).removeLabel
                        }}</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              } }

              <!-- Walidacja -->
              @if (form.get(field.name)?.invalid &&
              form.get(field.name)?.touched) {
              <div class="invalid-feedback">
                @if (form.get(field.name)?.errors?.['required']) {
                {{ field.label }} jest wymagane. } @if
                (form.get(field.name)?.errors?.['email']) { Podaj poprawny
                email. } @if (form.get(field.name)?.errors?.['min']) { Wartość
                za mała. } @if (form.get(field.name)?.errors?.['max']) { Wartość
                za duża. } @if (form.get(field.name)?.errors?.['pattern']) {
                {{ field.label }} nie spełnia wymaganego wzorca. } @if
                (form.get(field.name)?.errors?.['minlength']) {
                {{ field.label }} jest za krótki. } @if
                (form.get(field.name)?.errors?.['maxlength']) {
                {{ field.label }} jest za długi. }
              </div>
              }
            </div>
          </div>
          }
        </form>
      </div>
      <div class="modal-footer border-0">
        <button
          type="button"
          class="btn btn-secondary"
          data-bs-dismiss="modal"
          (click)="onClose()"
        >
          Zamknij
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="form.invalid"
          (click)="onSubmit()"
        >
          Zapisz
        </button>
      </div>
    </div>
  </div>
</div>
